generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

model customer_tag_relations {
  id          BigInt   @id @default(autoincrement())
  customer_id BigInt
  tag_id      Int
  created_at  DateTime @default(now())

  @@unique([customer_id, tag_id])
  @@index([tag_id], map: "customer_tag_relations_tag_id_fkey")
}

model customer_tags {
  id         Int      @id @default(autoincrement())
  tag_name   String   @unique
  created_at DateTime @default(now())
}

model customers {
  id                  BigInt    @id @default(autoincrement())
  shopify_customer_id String    @unique
  email               String    @unique
  password            String?
  first_name          String?
  last_name           String?
  phone               String?
  number_of_orders    String    @default("0")
  total_amount_spent  String    @default("0.0")
  currency_code       String    @default("USD")
  verified_email      Boolean   @default(false)
  valid_email_address Boolean   @default(true)
  lifetime_duration   String?
  note                String?
  can_delete          Boolean   @default(true)
  image_url           String?
  created_at          DateTime? @default(now())
  updated_at          DateTime?
  market_email        Boolean   @default(false)
  market_sms          Boolean   @default(false)
  shop_id             String?

  shop                   shop?                  @relation(fields: [shop_id], references: [id])
  customer_service_staff CustomerServiceStaff[]
  address                address[]
  Order                  Order[]
}

model shop {
  id                  String    @id @unique
  name                String
  email               String    @unique
  shop_owner_name     String
  shopify_plus        Boolean   @default(false)
  partner_development Boolean   @default(true)
  public_display_name String
  shopify_domain      String    @unique
  is_installed        Boolean   @default(false)
  createdAt           DateTime? @default(now())
  updatedAt           DateTime?

  customers customers[]
}

// 客服基本信息表
model StaffProfile {
  id         String    @id @default(uuid())
  name       String
  email      String?
  phone      String?
  avatarUrl  String?
  department String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime? @updatedAt

  staffs       CustomerServiceStaff[]
  ChatListItem ChatListItem[]

  @@map("staff_profiles")
}

model CustomerServiceStaff {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt

  profileId String
  profile   StaffProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  userId   BigInt
  customer customers? @relation(fields: [userId], references: [id])

  chatListItems ChatListItem[]

  @@unique([profileId, userId])
  @@map("customer_service_staff")
}

model session {
  id            String    @id @default(uuid())
  sessionId     String?   @map("session_id")
  shop          String?
  state         String?
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String?
  userId        BigInt?   @unique
  firstName     String?
  lastName      String?
  email         String?   @unique
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model Conversation {
  id        String             @id @default(uuid())
  shop      String             @db.VarChar(100)
  customer  String?            @db.VarChar(100)
  status    ConversationStatus @default(ACTIVE)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  messages      Message[]
  chatListItems ChatListItem[]

  @@index([shop, status])
  @@index([shop, customer])
  @@map("conversations")
}

model Message {
  id             String         @id @default(uuid())
  conversationId String         @db.VarChar(191)
  owner          String?        @db.VarChar(100)
  msgStatus      MsgStatus?
  senderId       String         @db.VarChar(191)
  senderType     SenderType
  recipientId    String?        @db.VarChar(191)
  recipientType  RecipientType?
  contentType    ContentType    @default(TEXT)
  contentBody    String         @db.Text
  metadata       Json?
  msgId          String?        @db.VarChar(100)

  timestamp DateTime @default(now())
  createdAt DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, timestamp])
  @@index([senderId, timestamp])
  @@map("messages")
}

// 离线消息模型
model OfflineMessage {
  id             String        @id @default(uuid())
  conversationId String        @db.VarChar(191)
  recipientId    String        @db.VarChar(191)
  recipientType  RecipientType
  senderId       String        @db.VarChar(191)
  senderType     SenderType
  contentType    ContentType
  contentBody    String        @db.Text
  metadata       Json?
  msgId          String        @db.VarChar(100)
  isDelivered    Boolean       @default(false)
  deliveredAt    DateTime?
  createdAt      DateTime      @default(now())

  @@index([recipientId, isDelivered])
  @@index([conversationId])
  @@map("offline_messages")
}

// 聊天列表项模型
model ChatListItem {
  id                 String    @id @default(uuid())
  conversationId     String    @unique @db.VarChar(191)
  customerId         String    @db.VarChar(191)
  customerFirstName  String?
  customerLastName   String?
  customerAvatar     String?
  lastMessage        String?   @db.Text
  lastTimestamp      DateTime?
  isOnline           Boolean   @default(false)
  hadRead            Boolean   @default(true)
  isActive           Boolean   @default(false)
  unreadMessageCount Int       @default(0)
  agentId            String?   @db.VarChar(191)
  shop               String    @db.VarChar(100)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  conversation         Conversation?          @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  agent                StaffProfile?          @relation(fields: [agentId], references: [id], onDelete: SetNull)
  CustomerServiceStaff CustomerServiceStaff[]

  @@index([agentId, shop])
  @@index([shop, customerId])
  @@index([lastTimestamp])
  @@map("chat_list_items")
}

// 订单状态枚举
enum OrderStatus {
  CREATED
  PAYMENT_PENDING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
  FAILED
}

// 退货状态枚举
enum ReturnStatus {
  NO_RETURN
  RETURN_REQUESTED
  RETURN_APPROVED
  RETURN_REJECTED
  RETURN_RECEIVED
  REFUND_PROCESSING
  REFUND_COMPLETED
}

// 货币枚举
enum CurrencyCode {
  CNY
  USD
  EUR
  GBP
  JPY
}

// 地址模型
model address {
  id         String   @id @default(cuid())
  customerId String
  name       String
  address1   String
  address2   String?
  city       String
  province   String
  country    String
  zip        String
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())

  customer customers @relation(fields: [customerId], references: [shopify_customer_id], onDelete: Cascade)
  Order    Order[]   @relation("OrderShippingAddress")

  Orders Order[]

  @@index([customerId])
  @@index([country, province, city])
  @@map("addresses")
}

// 订单主模型
model Order {
  id                 String  @id @default(cuid())
  name               String  @unique
  note               String?
  confirmationNumber String  @unique

  // 状态信息
  status       OrderStatus  @default(CREATED)
  returnStatus ReturnStatus @default(NO_RETURN)
  fullyPaid    Boolean      @default(false)
  unpaid       Boolean      @default(false)

  // 时间信息
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // 价格信息
  currencyCode       CurrencyCode @default(CNY)
  subtotalPrice      Decimal      @db.Decimal(10, 2) // 189.84
  totalTax           Decimal      @db.Decimal(10, 2) // 21.84
  totalShippingPrice Decimal      @db.Decimal(10, 2) // 4.95
  totalPrice         Decimal      @db.Decimal(10, 2) // 194.79
  totalReceived      Decimal      @db.Decimal(10, 2) // 194.79

  // 渠道信息
  channelInformation String  @default("Online Store") // 如 "Online Store"
  statusPageUrl      String?

  // 外部支付信息
  stripePaymentIntentId String?
  stripeSessionId       String?
  shopifyOrderId        String? @unique // gid://shopify/Order/6149102141628

  // 关系
  customerId        String?
  shippingAddressId String?

  customers       customers?           @relation(fields: [customerId], references: [shopify_customer_id], onDelete: Cascade)
  shippingAddress address?             @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id])
  lineItems       OrderLineItem[]
  taxLines        OrderTaxLine[]
  additionalFees  OrderAdditionalFee[]
  order_address   address?             @relation(fields: [order_addressId], references: [id])
  order_addressId String?

  @@index([customerId])
  @@index([status])
  @@index([processedAt])
  @@index([createdAt])
  @@index([confirmationNumber])
  @@index([shopifyOrderId])
  @@map("orders")
}

// 订单商品行模型
model OrderLineItem {
  id       String  @id @default(cuid())
  orderId  String
  title    String // 如 "感恩密码"
  quantity Int     @default(1)
  sku      String? // 如 "4223-407-360"

  // 价格信息
  originalUnitPrice Decimal @db.Decimal(10, 2) // 189.84
  price             Decimal @db.Decimal(10, 2) // 168.00

  // 商品变体信息
  variantTitle String?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([sku])
  @@map("order_line_items")
}

// 订单税费行模型
model OrderTaxLine {
  id             String  @id @default(cuid())
  orderId        String
  title          String // 如 "VAT"
  rate           Float // 0.13
  ratePercentage Int // 13
  price          Decimal @db.Decimal(10, 2) // 21.84
  source         String?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_tax_lines")
}

// 订单附加费用模型
model OrderAdditionalFee {
  id      String  @id @default(cuid())
  orderId String
  title   String
  price   Decimal @db.Decimal(10, 2)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("order_additional_fees")
}

enum ConversationStatus {
  ACTIVE
  RESOLVED
  ARCHIVED
}

enum SenderType {
  CUSTOMER
  AGENT
  SYSTEM
}

enum RecipientType {
  CUSTOMER
  AGENT
}

enum ContentType {
  TEXT
  IMAGE
  PRODUCT
  ORDER
  SYSTEM
}

enum MsgStatus {
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

model Product {
  id              String   @id @default(cuid())
  title           String
  description     String?
  descriptionHtml String?
  tags            String[]
  vendor          String
  featuredMediaId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  featuredMedia Media?               @relation("ProductFeaturedMedia", fields: [featuredMediaId], references: [id])
  variants      Variant[]
  media         Media[]              @relation("ProductMedia")
  translations  ProductTranslation[]
  variantsCount ProductVariantCount?
  mediaCount    ProductMediaCount?

  minPrice          Decimal?       @db.Decimal(10, 2)
  maxPrice          Decimal?       @db.Decimal(10, 2)
  minCompareAtPrice Decimal?       @db.Decimal(10, 2)
  maxCompareAtPrice Decimal?       @db.Decimal(10, 2)
  productMedias     ProductMedia[]

  @@index([vendor])
  @@index([tags])
  @@map("products")
}

model Variant {
  id           String   @id @default(cuid())
  price        Decimal  @db.Decimal(10, 2)
  unitPrice    Decimal? @db.Decimal(10, 2)
  currencyCode String?  @default("USD")
  sku          String?
  position     Int?

  productId String

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, position])
  @@index([productId])
  @@map("variants")
}

model Media {
  id               String    @id @default(cuid())
  mediaContentType String
  url              String
  thumbhash        String?
  featuredProducts Product[] @relation("ProductFeaturedMedia")
  productMedia     Product[] @relation("ProductMedia")

  preview       MediaPreview?
  productMedias ProductMedia[]

  @@index([mediaContentType])
  @@map("media")
}

model MediaPreview {
  id       String  @id @default(cuid())
  imageUrl String?
  mediaId  String  @unique

  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@map("media_previews")
}

model ProductVariantCount {
  id        String @id @default(cuid())
  count     Int
  productId String @unique

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_variant_counts")
}

model ProductMediaCount {
  id        String @id @default(cuid())
  count     Int
  productId String @unique

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_media_counts")
}

model ProductTranslation {
  id        String @id @default(cuid())
  productId String
  locale    String
  fieldName String
  value     String

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, locale, fieldName])
  @@index([productId])
  @@index([locale])
  @@map("product_translations")
}

model ProductMedia {
  id         String   @id @default(cuid())
  productId  String
  mediaId    String
  position   Int?     @default(0)
  isFeatured Boolean? @default(false)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  media   Media   @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([productId, mediaId])
  @@index([productId])
  @@index([mediaId])
  @@map("product_media")
}
